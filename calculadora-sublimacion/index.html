<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculadora de precios para trabajos de sublimaci√≥n">
    <meta name="theme-color" content="#3498db">
    <link rel="icon" type="image/png" sizes="32x32" href="/calculadora-sublimacion/icons/icon-128.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/calculadora-sublimacion/icons/icon-72.png">
    <link rel="manifest" href="/calculadora-sublimacion/manifest.json">
    <link rel="apple-touch-icon" href="/calculadora-sublimacion/icons/icon-192.png">
    <title>Calculadora de Precios - Sublimaci√≥n</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Notificaci√≥n de actualizaci√≥n -->
        <div id="update-notification" class="update-notification" style="display: none;">
            <div class="update-content">
                <span class="update-icon">üîÑ</span>
                <span class="update-text">¬°Nueva versi√≥n disponible!</span>
                <div class="update-buttons">
                    <button id="update-now" class="btn-update-now">Actualizar ahora</button>
                    <button id="update-later" class="btn-update-later">M√°s tarde</button>
                </div>
            </div>
        </div>

        <header>
            <h1>Calculadora de Precios de Sublimaci√≥n</h1>
            <p class="subtitle">Sistema de gesti√≥n de costos y precios</p>
        </header>

        <div class="calculator-layout">
            <!-- Vista de Tabs -->
            <div class="tab-content active" id="tab-calculator">
                <!-- Barra de Presets compacta -->
                <div class="presets-bar">
                    <button class="preset-icon-btn" data-product="taza" title="Taza">‚òï</button>
                    <button class="preset-icon-btn" data-product="polo" title="Polo">üëï</button>
                    <button class="preset-icon-btn" data-product="llavero" title="Llavero">üîë</button>
                    <button class="preset-icon-btn" data-product="tomatodo" title="Tomatodo">üç∂</button>
                    <button class="preset-icon-btn" data-product="mousepad" title="Mousepad">üñ±Ô∏è</button>
                    <button class="preset-icon-btn" data-product="personalizado" title="Personalizado">‚ú®</button>
                </div>

                <!-- Formulario de Costos -->
            <section class="card cost-form">
                <h2>Costos del Producto</h2>

                <div class="form-group">
                    <label for="producto-nombre">Nombre del producto:</label>
                    <input type="text" id="producto-nombre" placeholder="Ej: Taza blanca 11oz" required>
                </div>

                <div class="form-section">
                    <h3>Materiales</h3>
                    <div class="form-group">
                        <label for="costo-producto">Costo del producto base (S/):</label>
                        <input type="number" id="costo-producto" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="costo-tinta">Costo de tinta/sublimaci√≥n (S/):</label>
                        <input type="number" id="costo-tinta" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="costo-empaque">Costo de empaque/bolsa (S/):</label>
                        <input type="number" id="costo-empaque" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="otros-materiales">Otros materiales (S/):</label>
                        <input type="number" id="otros-materiales" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-section">
                    <h3>Gastos Operativos</h3>
                    <div class="form-group">
                        <label for="mano-obra">Mano de obra (S/):</label>
                        <input type="number" id="mano-obra" step="0.01" min="0" placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label for="gastos-generales">Gastos generales % (luz, alquiler, etc.):</label>
                        <input type="number" id="gastos-generales" step="0.1" min="0" max="100" value="10" placeholder="10">
                        <small>Porcentaje sobre costos totales</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Margen de Ganancia</h3>
                    <div class="form-group">
                        <label for="margen-ganancia">Margen de ganancia (%):</label>
                        <input type="number" id="margen-ganancia" step="1" min="0" max="500" value="40" placeholder="40">
                        <small>Ganancia sobre el costo total</small>
                    </div>
                </div>

                <div class="form-section">
                    <h3>Cantidad</h3>
                    <div class="form-group">
                        <label for="cantidad">Cantidad de productos:</label>
                        <input type="number" id="cantidad" step="1" min="1" value="1" placeholder="1">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="aplicar-descuento-volumen">
                            Aplicar descuento por volumen
                        </label>
                    </div>

                    <div id="info-descuento" style="display: none; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 5px; font-size: 0.9em;">
                        <strong>Descuento aplicado:</strong> <span id="descuento-aplicado-texto">0%</span>
                    </div>
                </div>

                <button id="calcular-btn" class="btn-primary">Calcular Precio</button>
                <button id="limpiar-btn" class="btn-secondary">Limpiar</button>
            </section>

            <!-- Resultados ahora se muestran en modal -->

            </div>
            <!-- Fin tab-calculator -->

            <!-- Historial en tab separado -->
            <div class="tab-content" id="tab-history">
                <section class="card history-section">
                    <h2>Historial de C√°lculos</h2>
                    <div id="historial-lista" class="historial-lista">
                        <p class="empty-message">No hay c√°lculos guardados a√∫n</p>
                    </div>
                </section>
            </div>

            <!-- Configuraci√≥n en tab separado -->
            <div class="tab-content" id="tab-config">
                <section class="card config-section">
                    <h2>‚öôÔ∏è Configuraci√≥n</h2>

                    <div class="config-group">
                        <h3>üìä Descuentos por Volumen</h3>
                        <p class="config-description">Define rangos de cantidad y sus descuentos correspondientes</p>

                        <div class="descuentos-config">
                            <div id="rangos-descuentos" class="rangos-lista">
                                <!-- Los rangos se renderizar√°n aqu√≠ din√°micamente -->
                            </div>

                            <button type="button" class="btn-secondary" id="agregar-rango-btn">
                                ‚ûï Agregar Rango
                            </button>
                        </div>
                    </div>

                    <!-- Secci√≥n de Versi√≥n -->
                    <div class="config-group">
                        <h3>üì± Informaci√≥n de la App</h3>
                        <div class="version-info">
                            <div class="version-item">
                                <span class="version-label">Versi√≥n:</span>
                                <span class="version-value" id="app-version">Cargando...</span>
                            </div>
                            <div class="version-item">
                                <span class="version-label">√öltima actualizaci√≥n:</span>
                                <span class="version-value" id="app-last-update">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n de Debug Console -->
                    <div class="config-group">
                        <h3>üêû Console de Debug</h3>
                        <p class="config-description">Visualiza logs y mensajes del sistema en tiempo real</p>
                        <button id="debug-toggle" class="btn-primary" style="width: 100%;">
                            üêû Abrir Console de Debug
                        </button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" data-tab="calculator">
                <span class="nav-icon">üßÆ</span>
                <span class="nav-label">Calculadora</span>
            </button>
            <button class="nav-item" data-tab="history">
                <span class="nav-icon">üìã</span>
                <span class="nav-label">Historial</span>
            </button>
            <button class="nav-item" data-tab="config">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Configuraci√≥n</span>
            </button>
        </nav>

    </div>

    <!-- Modal de Edici√≥n de Rango -->
    <div id="modal-editar-rango" class="modal">
        <div class="modal-content">
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 1.3rem; color: var(--dark-color);">‚úèÔ∏è Editar Rango</h2>
                    <button class="modal-close" id="cerrar-modal-editar-rango" style="position: static; background: var(--light-color); color: var(--text-secondary); width: 32px; height: 32px;">&times;</button>
                </div>

                <div class="form-group">
                    <label for="editar-desde">Desde (unidades):</label>
                    <input type="number" id="editar-desde" min="1" step="1" placeholder="1">
                </div>

                <div class="form-group">
                    <label for="editar-hasta">Hasta (unidades):</label>
                    <input type="number" id="editar-hasta" min="1" step="1" placeholder="Dejar vac√≠o para infinito">
                    <small>Dejar vac√≠o para indicar "infinito"</small>
                </div>

                <div class="form-group">
                    <label for="editar-descuento">Descuento (%):</label>
                    <input type="number" id="editar-descuento" min="0" max="100" step="0.1" placeholder="0">
                </div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-primary" id="guardar-edicion-rango">
                    üíæ Guardar Cambios
                </button>
                <button type="button" class="btn-secondary btn-eliminar" id="eliminar-rango-modal">
                    üóëÔ∏è Eliminar Rango
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Resultados -->
    <div id="modal-resultados" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-resultado-titulo">üí∞ Resultado del C√°lculo</h2>
                <button class="modal-close" id="cerrar-modal-resultados">&times;</button>
            </div>

            <div class="modal-body">
                <!-- Info de descuento -->
                <div id="info-descuento-modal" class="alert alert-info" style="display: none;">
                    <span id="descuento-aplicado-texto-modal"></span>
                </div>

                <!-- Tabla de resultados -->
                <table class="resultado-tabla">
                    <tr class="row-principal">
                        <td>Precio unitario</td>
                        <td id="precio-unitario-modal" class="valor-principal">S/ 0.00</td>
                    </tr>
                    <tr id="precio-total-row-modal" style="display: none;">
                        <td>Total (x<span id="cantidad-display-modal">1</span>)</td>
                        <td id="precio-total-modal" class="valor-secundario">S/ 0.00</td>
                    </tr>
                </table>

                <hr>

                <!-- Desglose -->
                <table class="resultado-tabla">
                    <tr>
                        <td>Materiales</td>
                        <td id="materiales-total-modal">S/ 0.00</td>
                    </tr>
                    <tr>
                        <td>Mano de obra</td>
                        <td id="resultado-mano-obra-modal">S/ 0.00</td>
                    </tr>
                    <tr>
                        <td>Gastos (<span id="porcentaje-gg-modal">10</span>%)</td>
                        <td id="resultado-gastos-modal">S/ 0.00</td>
                    </tr>
                </table>

                <hr>

                <!-- Totales -->
                <table class="resultado-tabla">
                    <tr class="row-destacado">
                        <td>Costo total</td>
                        <td id="costo-total-modal" class="valor-costo">S/ 0.00</td>
                    </tr>
                    <tr class="row-ganancia">
                        <td>Ganancia (<span id="porcentaje-ganancia-modal">40</span>%)</td>
                        <td id="resultado-ganancia-modal" class="valor-ganancia">S/ 0.00</td>
                    </tr>
                </table>

                <!-- Datos ocultos para c√°lculos -->
                <input type="hidden" id="resultado-producto-modal">
                <input type="hidden" id="resultado-tinta-modal">
                <input type="hidden" id="resultado-empaque-modal">
                <input type="hidden" id="resultado-otros-modal">
                <div id="resumen-totales-modal" style="display: none;">
                    <input type="hidden" id="cantidad-resumen-modal">
                    <input type="hidden" id="total-materiales-cantidad-modal">
                    <input type="hidden" id="total-mano-obra-cantidad-modal">
                    <input type="hidden" id="total-gastos-cantidad-modal">
                    <input type="hidden" id="total-costos-cantidad-modal">
                    <input type="hidden" id="total-ganancia-cantidad-modal">
                </div>

                <div class="action-buttons" id="modal-resultado-acciones">
                    <button id="guardar-btn-modal" class="btn-success">üíæ Guardar</button>
                    <button id="compartir-btn-modal" class="btn-info">üì§ Compartir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Debug Flotante -->
    <div id="debug-panel" class="debug-panel">
        <div class="debug-header">
            <span class="debug-title">üêû Console Debug</span>
            <div class="debug-actions">
                <button id="debug-clear" class="debug-btn" title="Limpiar">üóëÔ∏è</button>
                <button id="debug-close" class="debug-btn" title="Cerrar">‚úñÔ∏è</button>
            </div>
        </div>
        <div id="debug-content" class="debug-content"></div>
    </div>

    <script src="js/calculator.js"></script>
    <script src="js/presets.js"></script>
    <script src="js/history.js"></script>
    <script src="js/bulk-discount.js"></script>
    <script src="js/app.js"></script>
    <script>
        // ========================================
        // DEBUG CONSOLE CON PANEL FLOTANTE
        // ========================================
        (function() {
            const debugPanel = document.getElementById('debug-panel');
            const debugContent = document.getElementById('debug-content');
            const debugToggle = document.getElementById('debug-toggle');
            const debugClose = document.getElementById('debug-close');
            const debugClear = document.getElementById('debug-clear');
            let logs = [];
            const maxLogs = 100;

            // Funci√≥n para agregar log al panel
            function addLog(type, args) {
                const timestamp = new Date().toLocaleTimeString('es-PE', { hour12: false });
                const message = Array.from(args).map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');

                logs.push({ type, timestamp, message });
                if (logs.length > maxLogs) logs.shift();

                const logDiv = document.createElement('div');
                logDiv.className = `debug-log debug-${type}`;
                logDiv.innerHTML = `
                    <span class="debug-time">${timestamp}</span>
                    <span class="debug-type">[${type.toUpperCase()}]</span>
                    <span class="debug-msg">${message}</span>
                `;
                debugContent.appendChild(logDiv);
                debugContent.scrollTop = debugContent.scrollHeight;

                // Limitar elementos DOM
                while (debugContent.children.length > maxLogs) {
                    debugContent.removeChild(debugContent.firstChild);
                }
            }

            // Interceptar console.log
            const originalLog = console.log;
            console.log = function(...args) {
                originalLog.apply(console, args);
                addLog('log', args);
            };

            // Interceptar console.error
            const originalError = console.error;
            console.error = function(...args) {
                originalError.apply(console, args);
                addLog('error', args);
            };

            // Interceptar console.warn
            const originalWarn = console.warn;
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                addLog('warn', args);
            };

            // Interceptar console.info
            const originalInfo = console.info;
            console.info = function(...args) {
                originalInfo.apply(console, args);
                addLog('info', args);
            };

            // Capturar errores no manejados
            window.addEventListener('error', (event) => {
                addLog('error', [`Uncaught: ${event.message} at ${event.filename}:${event.lineno}`]);
            });

            // Toggle panel desde bot√≥n en config
            debugToggle.addEventListener('click', () => {
                debugPanel.classList.toggle('show');
                debugToggle.textContent = debugPanel.classList.contains('show')
                    ? '‚úñÔ∏è Cerrar Console de Debug'
                    : 'üêû Abrir Console de Debug';
            });

            // Close panel
            debugClose.addEventListener('click', () => {
                debugPanel.classList.remove('show');
                debugToggle.textContent = 'üêû Abrir Console de Debug';
            });

            // Clear logs
            debugClear.addEventListener('click', () => {
                debugContent.innerHTML = '';
                logs = [];
                addLog('info', ['Console limpiada']);
            });

            // Log inicial
            addLog('info', ['üêû Debug Console iniciada']);

            // Cargar informaci√≥n de versi√≥n
            if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' });
            }

            // Escuchar mensajes del Service Worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'VERSION_INFO') {
                    const versionEl = document.getElementById('app-version');
                    const lastUpdateEl = document.getElementById('app-last-update');

                    if (versionEl) {
                        versionEl.textContent = event.data.version || 'Desconocida';
                    }
                    if (lastUpdateEl && event.data.version) {
                        // Extraer fecha del formato: 20251218.033923-736eec0
                        const match = event.data.version.match(/(\d{8})\.(\d{6})/);
                        if (match) {
                            const date = match[1];
                            const time = match[2];
                            const formatted = `${date.substr(6,2)}/${date.substr(4,2)}/${date.substr(0,4)} ${time.substr(0,2)}:${time.substr(2,2)}`;
                            lastUpdateEl.textContent = formatted;
                        }
                    }
                }
            });

            // Funci√≥n para obtener versi√≥n del SW
            window.obtenerVersionSW = function() {
                if ('serviceWorker' in navigator) {
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ type: 'GET_VERSION' });
                        console.log('Solicitando versi√≥n al Service Worker...');
                    } else {
                        console.log('Service Worker a√∫n no est√° controlando la p√°gina');
                        document.getElementById('app-version').textContent = 'Cargando...';
                    }
                } else {
                    document.getElementById('app-version').textContent = 'No soportado';
                }
            };

            // Intentar obtener versi√≥n al cargar
            obtenerVersionSW();
        })();

        // Registrar Service Worker para PWA con notificaci√≥n de actualizaci√≥n
        if ('serviceWorker' in navigator) {
            let newWorkerWaiting = null;
            const updateNotification = document.getElementById('update-notification');
            const updateNowBtn = document.getElementById('update-now');
            const updateLaterBtn = document.getElementById('update-later');

            // Funci√≥n para mostrar notificaci√≥n de actualizaci√≥n
            function showUpdateNotification() {
                updateNotification.style.display = 'block';
                updateNotification.classList.add('show');
            }

            // Funci√≥n para ocultar notificaci√≥n
            function hideUpdateNotification() {
                updateNotification.classList.remove('show');
                setTimeout(() => {
                    updateNotification.style.display = 'none';
                }, 300);
            }

            // Actualizar ahora
            updateNowBtn.addEventListener('click', () => {
                if (newWorkerWaiting) {
                    newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
                }
                hideUpdateNotification();
            });

            // Actualizar m√°s tarde
            updateLaterBtn.addEventListener('click', () => {
                hideUpdateNotification();
            });

            navigator.serviceWorker.register('/calculadora-sublimacion/sw.js')
                .then(reg => {
                    console.log('Service Worker registrado', reg);

                    // Obtener versi√≥n cuando el SW est√© listo
                    if (navigator.serviceWorker.controller) {
                        // SW ya est√° activo
                        window.obtenerVersionSW();
                    } else {
                        // Esperar a que el SW tome control
                        navigator.serviceWorker.addEventListener('controllerchange', () => {
                            console.log('Service Worker ahora tiene control, obteniendo versi√≥n...');
                            setTimeout(() => window.obtenerVersionSW(), 500);
                        });
                    }

                    // Funci√≥n para verificar actualizaciones
                    function checkForUpdates() {
                        reg.update().then(() => {
                            console.log('Verificaci√≥n de actualizaci√≥n completada');
                        });
                    }

                    // Verificar actualizaciones cada 60 segundos (solo si la app est√° visible)
                    setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            checkForUpdates();
                        }
                    }, 60000);

                    // ANDROID FIX: Verificar cuando la app vuelve a estar visible
                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            console.log('App visible, verificando actualizaciones...');
                            checkForUpdates();
                        }
                    });

                    // ANDROID FIX: Verificar cuando la ventana recibe focus
                    window.addEventListener('focus', () => {
                        console.log('Window focus, verificando actualizaciones...');
                        checkForUpdates();
                    });

                    // Verificaci√≥n inicial
                    checkForUpdates();

                    // Detectar cuando hay una nueva versi√≥n
                    reg.addEventListener('updatefound', () => {
                        console.log('Update found!');
                        const newWorker = reg.installing;
                        newWorkerWaiting = newWorker;

                        newWorker.addEventListener('statechange', () => {
                            console.log('New worker state:', newWorker.state);
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // Nueva versi√≥n disponible, mostrar notificaci√≥n
                                console.log('Mostrando notificaci√≥n de actualizaci√≥n');
                                showUpdateNotification();
                            }
                        });
                    });
                })
                .catch(err => console.log('Error al registrar Service Worker', err));

            // Recargar cuando el nuevo service worker tome control
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                window.location.reload();
            });
        }
    </script>
</body>
</html>
